// URL вашей таблицы CSV
const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTOtUQAhnBMNrCPWFj0u6cjQeb0qWscrovHdCWvuBQMaCCirL4ds3i6NtjqwMpcReNsrhrY_X8ICXOL/pub?gid=2109115062&single=true&output=csv";

let products = [];
let cart = JSON.parse(localStorage.getItem('cart')) || [];
document.getElementById("cartCount").textContent = cart.length;

// --- Загрузка CSV ---
fetch(sheetURL)
  .then(r => r.text())
  .then(csv => {
    const rows = csv.split("\n").slice(1).filter(r => r.trim() !== "");
    const tempProducts = rows.map(r => {
      const c = r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
      return {
        cat: c[0],
        name: c[1],
        desc: c[2]?.replaceAll('"', '') || 'Описание отсутствует',
        img: c[3] || 'https://via.placeholder.com/300x180.png?text=Нет+изображения',
        p1: Number(c[4]) || 0,
        p2: Number(c[5]) || 0,
        p3: Number(c[6]) || 0,
        p5: Number(c[7]) || 0,
        avail: c[8] ? c[8].toString().trim().toLowerCase() === "да" : false
      };
    });

    // --- Убираем дубли по названию инструмента ---
    const seen = new Set();
    products = tempProducts.filter(p => {
      if (seen.has(p.name.toLowerCase())) return false;
      seen.add(p.name.toLowerCase());
      return true;
    });

    initFilters();
    applyFilters();
  });

// --- Фильтры ---
function initFilters() {
  const f = document.getElementById("categoryFilter");
  [...new Set(products.map(p => p.cat))].forEach(cat => {
    const o = document.createElement("option");
    o.value = cat;
    o.textContent = cat;
    f.appendChild(o);
  });
}

document.getElementById("search").addEventListener("input", applyFilters);
document.getElementById("categoryFilter").addEventListener("change", applyFilters);
document.getElementById("sortPrice").addEventListener("change", applyFilters);
document.getElementById("availableOnly").addEventListener("change", applyFilters);

function applyFilters() {
  let filtered = [...products];
  const search = document.getElementById("search").value.toLowerCase();
  const cat = document.getElementById("categoryFilter").value;
  const sort = document.getElementById("sortPrice").value;
  const available = document.getElementById("availableOnly").checked;

  if (cat !== "all") filtered = filtered.filter(p => p.cat === cat);
  if (search) filtered = filtered.filter(p => p.name.toLowerCase().includes(search));
  if (available) filtered = filtered.filter(p => p.avail);

  if (sort === "asc") filtered.sort((a, b) => a.p1 - b.p1);
  if (sort === "desc") filtered.sort((a, b) => b.p1 - a.p1);

  render(filtered);
}

// --- Рендер карточек ---
function render(list) {
  const cont = document.getElementById("products");
  cont.innerHTML = "";
  list.forEach(i => {
    const badgeClass = i.avail ? "yes" : "no";
    const badgeText = i.avail ? "В наличии" : "Нет";
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <span class="badge ${badgeClass}">${badgeText}</span>
      <img src="${i.img}" alt="${i.name}">
      <h3>${i.name}</h3>
      <div class="price">
        1 сутки: ${i.p1} ₽<br>
        2 суток: ${i.p2} ₽<br>
        3 суток: ${i.p3} ₽<br>
        от 5 суток: ${i.p5} ₽
      </div>
      <div class="card-details"><p>${i.desc}</p></div>
      <button onclick='addCart("${i.name}",${i.p1})'>В корзину</button>
      <a href="https://t.me/ArendMSK" target="_blank"><button>Арендовать</button></a>
    `;
    // Разворачивание карточки
    card.addEventListener("click", function(e) {
      if (!e.target.closest("button") && !e.target.closest("a")) {
        card.classList.toggle("open");
      }
    });
    cont.appendChild(card);
  });
}

// --- Корзина ---
function addCart(name, price) {
  cart.push({ name, price });
  localStorage.setItem('cart', JSON.stringify(cart));
  document.getElementById("cartCount").textContent = cart.length;
}

function openCart() { 
  document.getElementById("cartBox").style.display = "flex"; 
  renderCart(); 
}

function closeCart() { 
  document.getElementById("cartBox").style.display = "none"; 
}

function renderCart() {
  const box = document.getElementById("cartItems");
  box.innerHTML = "";
  cart.forEach(i => {
    const d = document.createElement("div");
    d.className = "cartItem";
    d.textContent = i.name + " - " + i.price + " ₽";
    box.appendChild(d);
  });
}

// --- Отправка заказа ---
function sendOrder() {
  if (!cart.length) return alert("Корзина пуста");
  const name = document.getElementById("clientName").value.trim();
  const phone = document.getElementById("clientPhone").value.trim();
  if (!name || !phone) return alert("Введите имя и телефон");

  let text = "ЗАКАЗ:%0A";
  cart.forEach(i => text += `${i.name} - ${i.price}₽%0A`);
  text += `Имя: ${name}%0AТелефон: ${phone}`;

  window.open("https://t.me/ArendMSK?text=" + text, "_blank");
}












